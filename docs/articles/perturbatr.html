<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>perturbatr cookbook • perturbatr</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/lumen/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">perturbatr</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/perturbatr.html">Tutorial</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/cbg-ethz/perturbatr">
    <span class="fa fa-github fa-2x"></span>
     
  </a>
</li>
<li>
  <a href="http://twitter.com/simon_dirmeier/">
    <span class="fa fa fa fa-twitter fa-2x"></span>
     
  </a>
</li>
<li>
  <a href="http://twitter.com/simon_dirmeier/">
    <span class="http://www.simon http://www.simon-dirmeier.net/static/_fig/cbg.png"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>perturbatr cookbook</h1>
                        <h4 class="author">Simon Dirmeier</h4>
            
            <h4 class="date">2018-03-22</h4>
          </div>

    
    
<div class="contents">
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function() {
  document.querySelector("h1").className = "title";
});
</script><script type="text/javascript">
document.addEventListener("DOMContentLoaded", function() {
  var links = document.links;  
  for (var i = 0, linksLength = links.length; i < linksLength; i++)
    if (links[i].hostname != window.location.hostname)
      links[i].target = '_blank';
});
</script><div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p><code>perturbatr</code> does stage-wise analysis of large-scale genetic perturbation screens for integrated data sets consisting of multiple screens. For multiple integrated perturbation screens a hierarchical model that considers the variance between different biological conditions is fitted. That means that we first estimate relative effect sizes for all genes. The resulting hit lists is then further extended using a network propagation algorithm to correct for false negatives.</p>
</div>
<div id="tutorial" class="section level1">
<h1 class="hasAnchor">
<a href="#tutorial" class="anchor"></a>Tutorial</h1>
<p>This tutorial walks you to the basic functionality of <code>perturbatr</code> using a pan-pathogenic data set of several RNAi screening studies.</p>
<div id="creating-a-perturbationdata-object" class="section level2">
<h2 class="hasAnchor">
<a href="#creating-a-perturbationdata-object" class="anchor"></a>Creating a <code>PerturbationData</code> object</h2>
<p>You supposedly start with something like a <code>data.frame</code> or <code>data.table</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">  <span class="kw">head</span>(my.data)</code></pre></div>
<pre><code>##   Condition Replicate   GeneSymbol Perturbation   Readout Control
## 1        V1         1         c1qb        fe584  885.5270       0
## 2        V1         1        ifnb1        8b2ec -246.3333       0
## 3        V1         1        ifna7        1c025 1136.2613       0
## 4        V1         1 dkfzp781d102        802b1 1200.0767       0
## 5        V1         1        lpar4        13651 2864.4256       0
## 6        V1         1         rfx4        f9386 1213.2341       0</code></pre>
<p>In order to create a perturbation data set you only need to call the <code>as</code> method:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">  my.perturbation.data &lt;-<span class="st"> </span>methods<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/methods/topics/as">as</a></span>(my.data, <span class="st">"PerturbationData"</span>)</code></pre></div>
<p>Coercing your <code>data.frame</code> to <code>PerturbationData</code> will automatically warn you if your table is formatted wrongly. You need at least the following column names order to be able to do analysis of perturbation screens using <code>perturbatr</code>:</p>
<ul>
<li>Condition: an identifier that best describes the respective screen. For instance this can be the name of a virus for pathogen screens, the name of a cell line, organoid or the like. The <em>condition</em> describes a single data set, i.e. if you want to integrate multiple different data sets, make sure to give each a different condition.</li>
<li>Replicate: an integer representing the replicate number of a screen.</li>
<li>GeneSymbol: the HUGO identifier, ENTREZ id, etc. as character.</li>
<li>Perturbation: a siRNA id or gRNA id that describes the knockout/knockdown for the gene.</li>
<li>Readout: a <em>normalized</em> readout like a log-fold change for gRNAs, a GFP signal, etc.</li>
<li>Control: vector of integers representing perturbations that have been used as negative or positive controls. A negative control is marked with ‘-1’, a positive control with ‘1’ and a normal sample with ‘0’.</li>
</ul>
<p>Depending on how you want to model the readout using the hierarchical model, you might want to add additional columns. For the sake of simplicity this suffices though.</p>
</div>
<div id="working-with-perturbationdata-s4-objects" class="section level2">
<h2 class="hasAnchor">
<a href="#working-with-perturbationdata-s4-objects" class="anchor"></a>Working with <code>PerturbationData</code> S4 objects</h2>
<p>A <code>PerturbationData</code> object consists of a single slot that stores your data. We bundled your data into an <code>S4</code> object such that dispatch is easier to handle and to make sure that your data set has the correct columns:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">  my.perturbation.data</code></pre></div>
<pre><code>## A perturbation data set
## 
## # A tibble: 4 x 3
## # Groups:   Condition [2]
##   Condition GeneSymbol Readout
##   &lt;chr&gt;     &lt;chr&gt;        &lt;dbl&gt;
## 1 V1        vps25        1853.
## 2 V1        rac3         -497.
## 3 V2        cep131       -445.
## 4 V2        eif3g         868.</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">  <span class="kw"><a href="../reference/dataSet-methods.html">dataSet</a></span>(my.perturbation.data)</code></pre></div>
<pre><code>## # A tibble: 23,040 x 6
##    Condition Replicate GeneSymbol   Perturbation Readout Control
##    &lt;chr&gt;         &lt;dbl&gt; &lt;chr&gt;        &lt;chr&gt;          &lt;dbl&gt;   &lt;int&gt;
##  1 V1               1. c1qb         fe584           886.       0
##  2 V1               1. ifnb1        8b2ec          -246.       0
##  3 V1               1. ifna7        1c025          1136.       0
##  4 V1               1. dkfzp781d102 802b1          1200.       0
##  5 V1               1. lpar4        13651          2864.       0
##  6 V1               1. rfx4         f9386          1213.       0
##  7 V1               1. cadm1        0e930          2885.       0
##  8 V1               1. lgr6         828d9          -259.       0
##  9 V1               1. tfap2c       433b6           835.       0
## 10 V1               1. adh6         b7829          -717.       0
## # ... with 23,030 more rows</code></pre>
<p><code>PerturbationData</code> has some basic <code>filter</code> and <code>rbind</code> functionality. Similar to <code><a href="http://dplyr.tidyverse.org/reference/filter.html">dplyr::filter</a></code> you can select rows by some predicate(s). In the example below we extract all rows from the data set that have a positive readout.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">  perturbatr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/perturbatr/topics/filter-methods">filter</a></span>(my.perturbation.data, Readout <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>)</code></pre></div>
<pre><code>## A perturbation data set
## 
## # A tibble: 4 x 3
## # Groups:   Condition [2]
##   Condition GeneSymbol Readout
##   &lt;chr&gt;     &lt;chr&gt;        &lt;dbl&gt;
## 1 V1        v5-1         1801.
## 2 V1        ethe1        1440.
## 3 V2        camlg        2263.
## 4 V2        ino80c        919.</code></pre>
<p>Filtering on multiple rows works by just adding predicates:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">  perturbatr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/perturbatr/topics/filter-methods">filter</a></span>(my.perturbation.data, Readout <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>, Replicate <span class="op">==</span><span class="st"> </span><span class="dv">2</span>)</code></pre></div>
<pre><code>## A perturbation data set
## 
## # A tibble: 4 x 3
## # Groups:   Condition [2]
##   Condition GeneSymbol Readout
##   &lt;chr&gt;     &lt;chr&gt;        &lt;dbl&gt;
## 1 V1        elovl4        99.5
## 2 V1        dgkq        1042. 
## 3 V2        or2m2        417. 
## 4 V2        dyrk1b       344.</code></pre>
<p>If you want to combine data sets you can call <code>rbind</code>, which will automatically dispatch on <code>PerturbationData</code> object:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">  dh &lt;-<span class="st"> </span>perturbatr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/perturbatr/topics/filter-methods">filter</a></span>(my.perturbation.data, Readout <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>, Replicate <span class="op">==</span><span class="st"> </span><span class="dv">2</span>)
  <span class="kw">rbind</span>(dh, dh)</code></pre></div>
<pre><code>## A perturbation data set
## 
## # A tibble: 4 x 3
## # Groups:   Condition [2]
##   Condition GeneSymbol Readout
##   &lt;chr&gt;     &lt;chr&gt;        &lt;dbl&gt;
## 1 V1        rps4x        1166.
## 2 V1        scnn1d        496.
## 3 V2        csf2rb       1708.
## 4 V2        smyd2         885.</code></pre>
</div>
<div id="data-analysis-using-a-hierarchical-model-and-network-diffusion" class="section level2">
<h2 class="hasAnchor">
<a href="#data-analysis-using-a-hierarchical-model-and-network-diffusion" class="anchor"></a>Data analysis using a hierarchical model and network diffusion</h2>
<p>Finally, after having set up the data set, we analyse it using a hierarchical model and network diffusion. We <strong>expect you already normalized the data sets accordingly</strong>. As noted above, if you want to analyse multiple data sets, make sure that every data set corresponds to a unique <code>Condition</code>.</p>
<p>For the sake of simplicity, you can model your readout as a linear combination of fixed effects and clustering effects for genes and genes nested in a condition:</p>
<p><span class="math display">\[y_{cgp} = x_c \beta + \gamma_g  + \delta_{cg} + \dots + y_{cgp}\]</span></p>
<p>where <span class="math inline">\(y_{cgpt}\)</span> is the phenotype for a condition <span class="math inline">\(c\)</span>, gene <span class="math inline">\(g\)</span> and perturbation <span class="math inline">\(p\)</span>. This would correspond to the <code>formula</code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">  Readout <span class="op">~</span><span class="st"> </span>Condition <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span><span class="op">|</span>GeneSymbol) <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span><span class="op">|</span>Condition<span class="op">:</span>GeneSymbol)</code></pre></div>
<p>which is the default argument. You can see that we model the gene effect using different intercepts for each gene. To use the hierarchical model with the above formula, call:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">  <span class="kw">data</span>(rnaiscreen)
  res &lt;-<span class="st"> </span><span class="kw"><a href="../reference/hm-methods.html">hm</a></span>(rnaiscreen, <span class="dt">effect.size=</span><span class="fl">0.01</span>)</code></pre></div>
<p>Depending on your data set different clustering effects might be present of course. So let’s have a look at our data again:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">  <span class="kw"><a href="../reference/dataSet-methods.html">dataSet</a></span>(rnaiscreen)</code></pre></div>
<pre><code>## # A tibble: 23,040 x 18
##    Condition Replicate Plate RowIdx ColIdx GeneSymbol ReadoutClass Readout
##    &lt;chr&gt;         &lt;dbl&gt; &lt;int&gt;  &lt;int&gt;  &lt;int&gt; &lt;chr&gt;      &lt;chr&gt;          &lt;dbl&gt;
##  1 V1               1.     1      1      1 c1qb       Readout         886.
##  2 V1               1.     1      1      2 ifnb1      Readout        -246.
##  3 V1               1.     1      1      3 ifna7      Readout        1136.
##  4 V1               1.     1      1      4 dkfzp781d… Readout        1200.
##  5 V1               1.     1      1      5 lpar4      Readout        2864.
##  6 V1               1.     1      1      6 rfx4       Readout        1213.
##  7 V1               1.     1      1      7 cadm1      Readout        2885.
##  8 V1               1.     1      1      8 lgr6       Readout        -259.
##  9 V1               1.     1      1      9 tfap2c     Readout         835.
## 10 V1               1.     1      1     10 adh6       Readout        -717.
## # ... with 23,030 more rows, and 10 more variables: ReadoutType &lt;chr&gt;,
## #   Control &lt;int&gt;, Library &lt;chr&gt;, Perturbation &lt;chr&gt;, Screen &lt;chr&gt;,
## #   Cell &lt;chr&gt;, ScreenType &lt;chr&gt;, NumCells &lt;int&gt;, Design &lt;chr&gt;,
## #   Entrez &lt;int&gt;</code></pre>
<p>For viral perturbation screens, as simulated by our example data set, we know that viruses make use of different host factors during their life cycle. That means while some genes are required during <em>entry and replication</em>, others might play a role in <em>assembly and release</em> of the virions. So we have reason to believe that the stage of the infection also introduces a clustering effect. In that case we would need to add a random effect for the stage of the infection. We estimated the effects using <code>lme4</code> <span class="citation">(Bates et al. 2014)</span>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">  frm &lt;-<span class="st"> </span>Readout <span class="op">~</span><span class="st"> </span>Condition <span class="op">+</span>
<span class="st">                   </span>(<span class="dv">1</span><span class="op">|</span>GeneSymbol) <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span><span class="op">|</span>Condition<span class="op">:</span>GeneSymbol) <span class="op">+</span>
<span class="st">                   </span>(<span class="dv">1</span><span class="op">|</span>ScreenType) <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span><span class="op">|</span>Condition<span class="op">:</span>ScreenType)
  res &lt;-<span class="st"> </span><span class="kw"><a href="../reference/hm-methods.html">hm</a></span>(rnaiscreen, <span class="dt">formula =</span> frm, <span class="dt">effect.size=</span><span class="fl">0.01</span>)</code></pre></div>
<p><strong>Note that for your own data different effects might be visible. Thus,</strong> <strong>before modelling you need to exploratorily detect possible effects.</strong></p>
<p>Let’s take the last result and plot them. This yields a list of multiple plots. The most informative one that shows the top 25 genes:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">  pl &lt;-<span class="st"> </span><span class="kw">plot</span>(res)
  pl[[<span class="dv">1</span>]]</code></pre></div>
<pre><code>## [1] "Error in filter_impl(.data, quo) : \n  Evaluation error: argument \"x\" is missing, with no default.\n"
## attr(,"class")
## [1] "try-error"
## attr(,"condition")
## &lt;Rcpp::eval_error in filter_impl(.data, quo): Evaluation error: argument "x" is missing, with no default.&gt;</code></pre>
<p>Next we might want to <em>smooth</em> the effect from the hierarchical model using network diffusion, by that possibly reduce the number of some false negatives. For that we need a graph file and call the <code>diffuse</code> function. If we plot the results we get a list of reranked genes:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">  graph.file &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">"extdata"</span>, <span class="st">"graph_file.tsv"</span>,
                            <span class="dt">package =</span> <span class="st">"perturbatr"</span>)
  diffu      &lt;-<span class="st"> </span><span class="kw"><a href="../reference/diffuse-methods.html">diffuse</a></span>(res, <span class="dt">path=</span>graph.file, <span class="dt">r=</span><span class="fl">0.1</span>)
  <span class="kw">plot</span>(diffu)</code></pre></div>
<p><img src="perturbatr_files/figure-html/unnamed-chunk-12-1.png" width="384" style="display: block; margin: auto;"></p>
</div>
<div id="session-info" class="section level2">
<h2 class="hasAnchor">
<a href="#session-info" class="anchor"></a>Session info</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">  <span class="kw">sessionInfo</span>()</code></pre></div>
<pre><code>## R version 3.4.3 (2017-11-30)
## Platform: x86_64-apple-darwin15.6.0 (64-bit)
## Running under: macOS High Sierra 10.13.3
## 
## Matrix products: default
## BLAS: /Library/Frameworks/R.framework/Versions/3.4/Resources/lib/libRblas.0.dylib
## LAPACK: /Library/Frameworks/R.framework/Versions/3.4/Resources/lib/libRlapack.dylib
## 
## locale:
## [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
## [1] bindrcpp_0.2       perturbatr_0.99.13 dplyr_0.7.4       
## [4] BiocStyle_2.6.1   
## 
## loaded via a namespace (and not attached):
##  [1] Rcpp_0.12.16         nloptr_1.0.4         pillar_1.2.1        
##  [4] compiler_3.4.3       plyr_1.8.4           bindr_0.1           
##  [7] iterators_1.0.9      tools_3.4.3          lme4_1.1-15         
## [10] digest_0.6.15        nlme_3.1-131         lattice_0.20-35     
## [13] evaluate_0.10.1      tibble_1.4.2         gtable_0.2.0        
## [16] pkgconfig_2.0.1      rlang_0.2.0.9000     Matrix_1.2-12       
## [19] foreach_1.4.4        igraph_1.1.2         cli_1.0.0           
## [22] yaml_2.1.16          parallel_3.4.3       gridExtra_2.3       
## [25] stringr_1.3.0        knitr_1.18           tidyselect_0.2.3    
## [28] rprojroot_1.3-2      grid_3.4.3           glue_1.2.0          
## [31] R6_2.2.2             rmarkdown_1.8        minqa_1.2.4         
## [34] purrr_0.2.4          tidyr_0.8.0          ggplot2_2.2.1.9000  
## [37] diffusr_0.1.2        magrittr_1.5         MASS_7.3-48         
## [40] splines_3.4.3        backports_1.1.2      scales_0.5.0.9000   
## [43] codetools_0.2-15     operator.tools_1.6.3 htmltools_0.3.6     
## [46] formula.tools_1.7.1  assertthat_0.2.0     colorspace_1.4-0    
## [49] utf8_1.1.3           stringi_1.1.6        lazyeval_0.2.1      
## [52] doParallel_1.0.11    munsell_0.4.3        crayon_1.3.4</code></pre>
</div>
<div id="references" class="section level2 unnumbered">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<div id="refs" class="references">
<div id="ref-bates2014lme4">
<p>Bates, Douglas, Martin Maechler, Ben Bolker, Steven Walker, and others. 2014. “Lme4: Linear Mixed-Effects Models Using Eigen and S4.” <em>R Package Version</em> 1 (7): 1–23.</p>
</div>
</div>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li>
<a href="#tutorial">Tutorial</a><ul class="nav nav-pills nav-stacked">
<li><a href="#creating-a-perturbationdata-object">Creating a <code>PerturbationData</code> object</a></li>
      <li><a href="#working-with-perturbationdata-s4-objects">Working with <code>PerturbationData</code> S4 objects</a></li>
      <li><a href="#data-analysis-using-a-hierarchical-model-and-network-diffusion">Data analysis using a hierarchical model and network diffusion</a></li>
      <li><a href="#session-info">Session info</a></li>
      <li><a href="#references">References</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by <a href="http://www.simon-dirmeier.net">Simon Dirmeier</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
