---
title: "Analysis of pan-viral RNAi screens"
author: "Simon Dirmeier"
date: "`r Sys.Date()`"
output:
  BiocStyle::html_document:
    toc: true
    toc_depth: 2
    toc_float: true
bibliography: perturbatr.bib
vignette: >
  %\VignetteIndexEntry{perturbatr cookbook}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r style, echo=FALSE, results='asis'}
  BiocStyle::markdown()
  knitr::opts_chunk$set(echo = TRUE)
  library(dplyr)
  library(methods)
  library(perturbatr)
```

# Introduction

Here we show an example data analysis using a pan-pathogenic data set of three RNAi screening studies.
The data set consists of two kinome and a druggable genome wide RNAi screen and have been 
published in @reiss2011recruitment (HCV) and @de2015kinome (SARS).

# Data analysis

We start with loading the sample data set into memory:

```{r, include=TRUE, size="tiny"}
  data("rnaiscreen")
```

`rnaiscreen` data is of class `PerturbationData` data which supports several methods.
In our example we already normalized the data set appropriately, so no preprocessing is required.

Before we start, lets have a look at the data in more detail.
```{r, include=TRUE, size="tiny"}
  plot(rnaiscreen)
```

We have roughly the same number of replicates per gene, but the HCV screen has less genes
than the SARS data set. That is no problem however, because we automatically filter such that the genes are same.
We also automatically remove positive controls for obvious reasons.

Next we rank the genes using a hierarchical model which requires explicitely modelling the readout of our data set using an
R `formula`. Let's look at the data in more detail first:

```{r}
dataSet(rnaiscreen) %>% 
  str()
```

Here, variables like `Replicate`, `Plate`, `RowIdx/ColIdx` should not be associated with a change in the response `Readout` as we normalized the data and corrected for batch effects.
However, the `Readout`s should definitely have been different between `ScreenType`s:

```{r}
  dataSet(rnaiscreen) %>% pull(ScreenType) %>% unique()
```

where `E/R` represents that the screen has measured the effect of a gene knockdown during the *entry and replication* stages of the viral 
lifecycle while `A/R` repesents the gene knockdown's effect having been measures during the *assembly and release* stages of the lifecycle.

A model selection using the Bayesian information criterion indeed suggests the following hierarchical random intercept model:

$$y_{cgtp} \mid\gamma_g, \delta_{cg}, \zeta_t , \xi_{ct} \sim \mathcal{N}(x_c \beta + \gamma_g  + \delta_{cg} + \zeta_t + \xi_{ct},  \sigma^2),$$
where $y_{cgtp}$ is the readout of virus $c$, gene $g$, stage of the viral lifecycle $t$ (`E/R` vs `A/R`) and $p$ is the perturbation (siRNA) used for gene $g$.
We estimate the parameters of the model using `lme4` [@bates2014lme4]:

```{r, eval=TRUE, include=TRUE, warning=FALSE, message=FALSE}
  frm <- Readout ~ Condition +
                   (1|GeneSymbol) + (1|Condition:GeneSymbol) +
                   (1|ScreenType) + (1|Condition:ScreenType)
  res <- hm(rnaiscreen, formula = frm, effect.size=0.01)
```


## Session info

```{r eval=TRUE, include=TRUE}
  sessionInfo()
```

## References
